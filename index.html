// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Google Apps Script: Code.gs
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function doPost(e) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("ì‘ë‹µ");
  const data = JSON.parse(e.postData.contents);
  const now = new Date();
  const hour = now.getHours();

  // ì‹œê°„ ì œí•œ í™•ì¸ (ì˜¤ì „ 8ì‹œ ~ 9ì‹œ)
  if (hour < 8 || hour >= 9) {
    return ContentService.createTextOutput("âŒ ì§€ê¸ˆì€ ì‘ë‹µ ì‹œê°„ì´ ì•„ë‹ˆì—ìš”! (ì˜¤ì „ 8ì‹œ~9ì‹œë§Œ ê°€ëŠ¥)");
  }

  const todayDate = Utilities.formatDate(now, "Asia/Seoul", "yyyy-MM-dd");
  const studentId = data.studentId;

  // ì¤‘ë³µ ì‘ë‹µ í™•ì¸
  const records = sheet.getDataRange().getValues();
  for (let i = 1; i < records.length; i++) {
    const row = records[i];
    const recordedId = row[0];
    const recordedDate = Utilities.formatDate(new Date(row[3]), "Asia/Seoul", "yyyy-MM-dd");
    if (recordedId == studentId && recordedDate === todayDate) {
      return ContentService.createTextOutput("âš ï¸ ì´ë¯¸ ì˜¤ëŠ˜ ì‘ë‹µí–ˆì–´ìš”! ë‚´ì¼ ë˜ ë„ì „í•´ ì£¼ì„¸ìš” ğŸ˜Š");
    }
  }

  // ì •ë‹µ í™•ì¸ ë° ì €ì¥
  const todayAnswer = getTodayAnswer();
  const isCorrect = data.answer === todayAnswer ? "ì •ë‹µ" : "ì˜¤ë‹µ";

  sheet.appendRow([
    studentId,
    data.name,
    data.answer,
    Utilities.formatDate(now, "Asia/Seoul", "yyyy-MM-dd HH:mm:ss"),
    isCorrect
  ]);

  const rank = sheet.getLastRow() - 1;
  return ContentService.createTextOutput(`âœ… ì œì¶œ ì™„ë£Œ! ì§€ê¸ˆ ${rank}ë²ˆì§¸ë¡œ ì‘ë‹µí–ˆì–´ìš” ğŸŒŸ`);
}

// ë‚ ì§œë³„ ì •ë‹µ ë§¤í•‘
function getTodayAnswer() {
  const date = Utilities.formatDate(new Date(), "Asia/Seoul", "yyyyMMdd");
  const quizMap = {
    "20250714": "O",
    "20250715": "X",
    "20250716": "2",
    // í•„ìš”í•œ ë‚ ì§œ & ì •ë‹µ ì¶”ê°€í•˜ì„¸ìš”
  };
  return quizMap[date] || "O";
}

